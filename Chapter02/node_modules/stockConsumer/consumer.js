const EventEmitter = require('events');

class Consumer extends EventEmitter {
  constructor(code) {
    super();

    this.code = code;
  }

  // next MUST be called in a synchronous manner because we want to read a
  // single line at a time from the
  readStocks() {
    const path = require('path');

    const csvPath = path.join(__dirname, '..', '..', 'stock-price-' + this.code + '.csv');

    require('fs').readFile(csvPath, 'utf-8', (err, data) => {
      let innerContent;
        console.log('data: ' + data);
        console.log("Asynchronous read: " + data.toString());

        let price = {};
        const lines = data.toString().split('\n');

        for (let line of lines) {
          innerContent += line + '<br>';
          const properties = line.split(",");

          const previousPrice = price;
          price = {
              'timestamp' : properties[0],
              'open'      : properties[1],
              'close'     : properties[2],
              'previous'  : previousPrice
          }

          console.log("Price on line is ", price);
          this.emit('stock_updated', price);
        }
    });
  }
}

module.exports = Consumer;
